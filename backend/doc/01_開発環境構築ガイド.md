# 📚 FastAPI リアルタイム在庫・価格監視API 開発環境構築ガイド

## 📖 目次

1. [概要](#概要)
2. [必要なツール](#必要なツール)
3. [プロジェクト構造の理解](#プロジェクト構造の理解)
4. [開発環境セットアップ](#開発環境セットアップ)
5. [API動作確認](#api動作確認)
6. [トラブルシューティング](#トラブルシューティング)
7. [次のステップ](#次のステップ)

---

## 📋 概要

### 🎯 このガイドで学ぶこと

このガイドでは、**リアルタイム在庫・価格変動監視API**の開発環境を構築する方法を学びます。

- **FastAPI**: モダンなPython Webフレームワーク
- **PostgreSQL**: 信頼性の高いリレーショナルデータベース  
- **Redis**: 高速キャッシュとリアルタイム通信
- **WebSocket**: リアルタイムデータ配信
- **Docker**: 開発環境の統一化

### 🏗️ アーキテクチャ図

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   フロントエンド  │◄──►│  FastAPI サーバー │◄──►│   PostgreSQL   │
│   (React/Vue)   │    │  (Python 3.11+) │    │   データベース   │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         ▲                       │                       
         │              ┌─────────────────┐              
         └──WebSocket───►│     Redis       │              
                         │ (キャッシュ・通信) │              
                         └─────────────────┘              
```

### ⚡ 主要機能

- **🔄 リアルタイム通信**: WebSocketによる即座のデータ配信
- **📊 在庫管理**: CRUD操作による在庫アイテム管理
- **💰 価格管理**: 動的価格設定と履歴管理
- **⚠️ アラート機能**: 在庫不足・価格変動の自動通知
- **🚀 高性能**: 非同期処理とRedisキャッシング

---

## 🛠️ 必要なツール

### 💻 ソフトウェア要件

| ツール | バージョン | 用途 | インストール確認 |
|--------|-----------|------|-----------------|
| **Python** | 3.11+ | メインプログラミング言語 | `python3 --version` |
| **Docker Desktop** | 最新版 | データベース・Redis実行 | Docker メニューバーアイコン |
| **Node.js** | 18+ | WebSocketテストツール用 | `node --version` |
| **curl** | 標準搭載 | API テスト | `curl --version` |

### 📥 インストール手順 (Mac)

#### 1. Python 3.11+ のインストール
```bash
# Homebrew でインストール (推奨)
brew install python@3.11

# または公式サイトからダウンロード
# https://www.python.org/downloads/
```

#### 2. Docker Desktop のインストール
```bash
# 公式サイトからダウンロード・インストール
# https://www.docker.com/products/docker-desktop/

# インストール後、Applications から Docker を起動
open -a Docker
```

#### 3. Node.js のインストール
```bash
# Homebrew でインストール
brew install node

# または公式サイトから
# https://nodejs.org/
```

### ✅ インストール確認

すべてのツールが正しくインストールされているか確認します：

```bash
# Python バージョン確認
python3 --version
# 出力例: Python 3.11.3

# Docker 確認
docker --version
# 出力例: Docker version 20.10.24

# Node.js 確認
node --version
# 出力例: v18.16.0

# curl 確認
curl --version
# 出力例: curl 7.87.0
```

---

## 📁 プロジェクト構造の理解

### 🗂️ ディレクトリ構造

```
backend/
├── 📄 README.md                    # プロジェクト説明書
├── 📄 requirements.txt             # Python依存関係リスト
├── 📄 docker-compose.yml           # Dockerサービス定義
├── 📄 .env                         # 環境変数設定ファイル
│
├── 📁 app/                         # メインアプリケーションコード
│   ├── 📄 main.py                  # FastAPIエントリーポイント
│   │
│   ├── 📁 api/v1/                  # APIバージョン1
│   │   ├── 📄 api.py               # APIルーター集約
│   │   └── 📁 endpoints/           # エンドポイント定義
│   │       ├── 📄 inventory.py     # 在庫API
│   │       └── 📄 price.py         # 価格API
│   │
│   ├── 📁 core/                    # コア設定
│   │   ├── 📄 config.py            # アプリケーション設定
│   │   ├── 📄 database.py          # データベース接続
│   │   └── 📄 redis_client.py      # Redis接続
│   │
│   ├── 📁 models/                  # データベースモデル
│   │   ├── 📄 inventory.py         # 在庫テーブル定義
│   │   └── 📄 price.py             # 価格テーブル定義
│   │
│   ├── 📁 schemas/                 # Pydantic スキーマ
│   │   ├── 📄 inventory.py         # 在庫データ検証
│   │   └── 📄 price.py             # 価格データ検証
│   │
│   └── 📁 services/                # ビジネスロジック
│       ├── 📄 inventory_service.py # 在庫操作ロジック
│       ├── 📄 price_service.py     # 価格操作ロジック
│       └── 📄 websocket_manager.py # リアルタイム通信
│
├── 📁 doc/                         # ドキュメント (このファイルなど)
├── 📁 tests/                       # テストコード
└── 📁 venv/                        # Python仮想環境 (作成後)
```

### 🔍 主要ファイルの役割

#### `main.py` - アプリケーションの入り口
```python
# FastAPI アプリケーションの起動とミドルウェア設定
app = FastAPI(title="リアルタイム在庫・価格監視API")
```

#### `config.py` - 設定の集約
```python
# データベースURL、Redis URL、秘密鍵などの設定
DATABASE_URL = "postgresql+asyncpg://postgres:postgres@localhost:5432/inventory_monitoring"
```

#### `docker-compose.yml` - インフラ定義
```yaml
# PostgreSQL と Redis の起動設定
services:
  postgres: # データベース
  redis:    # キャッシュ・メッセージング
```

#### `requirements.txt` - Python パッケージ
```
fastapi==0.104.1      # Webフレームワーク
asyncpg==0.29.0       # PostgreSQL非同期ドライバ
redis==5.0.1          # Redisクライアント
# ... その他
```

---

## 🚀 開発環境セットアップ

### 📍 ステップ1: プロジェクトディレクトリに移動

```bash
# バックエンドディレクトリに移動
cd /Users/kouta.ozawa/Git/_personal/real-time-inventory-and-price-fluctuation-monitoring-api/backend

# 現在の場所を確認
pwd
# 出力: /Users/kouta.ozawa/Git/_personal/real-time-inventory-and-price-fluctuation-monitoring-api/backend
```

### 🐳 ステップ2: Dockerサービス起動

#### Docker Desktop起動確認
```bash
# Docker Desktopが起動しているか確認
docker info
# エラーが出る場合は、Applications から Docker を起動してください
```

#### PostgreSQL と Redis 起動
```bash
# データベースとキャッシュサービスを起動
docker-compose up -d postgres redis

# 起動確認
docker-compose ps
```

**正常な出力例:**
```
NAME                 STATUS
backend-postgres-1   Up 2 minutes (healthy)
backend-redis-1      Up 2 minutes (healthy)
```

### 🐍 ステップ3: Python仮想環境セットアップ

#### 仮想環境作成
```bash
# Python仮想環境を作成
python3 -m venv venv

# 作成確認
ls -la venv/
# venv/ ディレクトリが作成されることを確認
```

#### 仮想環境有効化
```bash
# 仮想環境を有効化
source venv/bin/activate

# 有効化確認 (プロンプトに (venv) が表示される)
# (venv) username@hostname:backend$
```

#### 依存関係インストール
```bash
# pip を最新版にアップデート
pip install --upgrade pip

# プロジェクトの依存関係をインストール
pip install -r requirements.txt

# インストール確認
pip list | head -10
```

### ⚙️ ステップ4: 環境変数設定

#### .envファイル確認・編集
```bash
# 環境変数ファイルの内容確認
cat .env

# 必要に応じて編集 (通常はそのままで OK)
# nano .env
```

**.env ファイルの内容例:**
```bash
# Database
DATABASE_URL=postgresql+asyncpg://postgres:postgres@localhost:5432/inventory_monitoring

# Redis
REDIS_URL=redis://localhost:6379

# Application
LOG_LEVEL=INFO
ENVIRONMENT=development

# Security
SECRET_KEY=development-secret-key-change-in-production
ALGORITHM=HS256
ACCESS_TOKEN_EXPIRE_MINUTES=30
```

### 🚀 ステップ5: FastAPIサーバー起動

```bash
# FastAPI サーバーを開発モードで起動
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

**正常な出力例:**
```
INFO:     Will watch for changes in these directories: ['/Users/kouta.ozawa/...']
INFO:     Uvicorn running on http://0.0.0.0:8000 (Press CTRL+C to quit)
INFO:     Started reloader process [12345] using WatchFiles
INFO:     Started server process [12346]
INFO:     Waiting for application startup.

2025-12-09 13:18:14 [info] Starting Real-Time Inventory Monitoring API
2025-12-09 13:18:14 [info] Redis connection established successfully  
2025-12-09 13:18:15 [info] Database tables created successfully
2025-12-09 13:18:15 [info] Database and Redis connections established

INFO:     Application startup complete.
```

**🎉 起動成功！サーバーが `http://localhost:8000` で稼働開始です。**

---

## 🧪 API動作確認

### 🌐 ブラウザでアクセス

以下のURLにブラウザでアクセスしてみましょう：

| URL | 説明 | 期待される表示 |
|-----|------|---------------|
| **http://localhost:8000/health** | ヘルスチェック | `{"status":"healthy","service":"inventory-monitoring-api"}` |
| **http://localhost:8000/docs** | API ドキュメント | Swagger UI インターフェース |
| **http://localhost:8000/redoc** | API リファレンス | ReDoc ドキュメント |

### 💻 コマンドラインでのAPI テスト

#### 1. ヘルスチェック
```bash
# サーバーが正常に動作しているか確認
curl http://localhost:8000/health

# 期待される出力:
# {"status":"healthy","service":"inventory-monitoring-api"}
```

#### 2. 在庫一覧取得 (初期状態では空)
```bash
# 在庫アイテム一覧を取得
curl http://localhost:8000/api/v1/inventory/

# 期待される出力:
# []  (初期状態では空の配列)
```

#### 3. テスト在庫アイテムの作成
```bash
# 新しい在庫アイテムを作成
curl -X POST http://localhost:8000/api/v1/inventory/ \
  -H "Content-Type: application/json" \
  -d '{
    "sku": "TEST-001",
    "name": "テスト商品",
    "description": "動作確認用のテスト商品",
    "category": "Electronics",
    "stock_quantity": 50,
    "reserved_quantity": 5,
    "weight": 250.0,
    "dimensions": "20cm x 18cm x 8cm",
    "cost_price": 8000.0,
    "min_stock_level": 10,
    "max_stock_level": 200,
    "is_active": true,
    "is_trackable": true
  }'
```

**成功時の出力例:**
```json
{
  "sku": "TEST-001",
  "name": "テスト商品",
  "description": "動作確認用のテスト商品",
  "category": "Electronics",
  "id": 1,
  "stock_quantity": 50,
  "reserved_quantity": 5,
  "available_quantity": 45,
  "created_at": "2025-12-09T04:19:39.525844Z",
  "updated_at": "2025-12-09T04:19:39.525844Z",
  "is_low_stock": false,
  "stock_status": "in_stock"
}
```

#### 4. 作成した在庫アイテムの確認
```bash
# 在庫一覧を再取得（今度はデータがある）
curl http://localhost:8000/api/v1/inventory/ | python3 -m json.tool
```

#### 5. 価格データの作成
```bash
# 作成した在庫アイテム（ID: 1）に価格を設定
curl -X POST http://localhost:8000/api/v1/price/ \
  -H "Content-Type: application/json" \
  -d '{
    "inventory_id": 1,
    "selling_price": 12000.0,
    "cost_price": 8000.0,
    "discount_price": 10800.0,
    "currency": "JPY",
    "margin_percent": 25.0,
    "markup_percent": 50.0,
    "is_active": true,
    "requires_approval": false
  }'
```

#### 6. 価格一覧の確認
```bash
# 価格一覧を取得
curl http://localhost:8000/api/v1/price/ | python3 -m json.tool
```

### 🔌 WebSocket 動作確認

#### WebSocket テストツールのインストール
```bash
# wscat をグローバルインストール
npm install -g wscat
```

#### WebSocket 接続テスト
```bash
# 在庫更新のWebSocket接続をテスト
wscat -c ws://localhost:8000/ws/inventory

# 接続成功時:
# Connected (press CTRL+C to quit)

# Ctrl+C で終了
```

**WebSocket接続時のサーバーログ例:**
```
2025-12-09 13:21:30 [info] WebSocket client connected  connection_type=inventory total_connections=1
2025-12-09 13:21:30 [info] Subscribed to Redis channel channel=inventory:updates
```

---

## 🔧 トラブルシューティング

### ❌ よくあるエラーと対処法

#### 1. Docker関連エラー

**エラー**: `Cannot connect to the Docker daemon`
```bash
# 対処法: Docker Desktop を起動
open -a Docker

# 起動確認
docker info
```

**エラー**: `port is already allocated`
```bash
# 対処法: ポート使用状況確認・プロセス終了
lsof -i :8000    # FastAPI ポート確認
lsof -i :5432    # PostgreSQL ポート確認
lsof -i :6379    # Redis ポート確認

# 使用中プロセスを終了
kill <PID>
```

#### 2. Python環境エラー

**エラー**: `command not found: uvicorn`
```bash
# 対処法: 仮想環境の有効化
source venv/bin/activate

# 依存関係再インストール
pip install -r requirements.txt
```

**エラー**: `ImportError` or `ModuleNotFoundError`
```bash
# 対処法: 依存関係確認・再インストール
pip list
pip install --upgrade pip
pip install -r requirements.txt
```

#### 3. データベース接続エラー

**エラー**: Database connection failed
```bash
# PostgreSQL 接続テスト
docker exec -it backend-postgres-1 psql -U postgres -c "SELECT 1;"

# Redis 接続テスト
docker exec -it backend-redis-1 redis-cli ping
# 期待される出力: PONG
```

#### 4. API エラー

**エラー**: HTTP 500 Internal Server Error
```bash
# サーバーログ確認
# FastAPIサーバーのターミナルでエラーメッセージを確認

# 設定ファイル確認
cat .env
```

### 🔍 詳細診断コマンド

```bash
# システム全体の状態確認
echo "=== Docker サービス状態 ==="
docker-compose ps

echo "=== Python 環境 ==="
which python3
python3 --version
pip list | grep -E "(fastapi|uvicorn|asyncpg|redis)"

echo "=== ネットワーク ==="
curl -I http://localhost:8000/health

echo "=== ログ確認 ==="
docker-compose logs --tail=10 postgres redis
```

---

## 🎯 次のステップ

### 📚 学習の進め方

#### 1. **API理解の深化**
- **Swagger UI** (`http://localhost:8000/docs`) で全エンドポイントを確認
- 各APIの入力パラメーターと出力フォーマットを理解
- エラーハンドリングの動作を確認

#### 2. **データ操作の練習**
- 複数の在庫アイテム作成
- 価格の更新・履歴確認
- 在庫不足アラート機能のテスト

#### 3. **リアルタイム機能の体験**
- WebSocket接続を維持しながらAPI操作
- ブラウザとcurlを同時使用してリアルタイム更新を確認
- Redis Pub/Sub メッセージの流れを理解

#### 4. **コードリーディング**
```bash
# 主要ファイルの読解
cat app/main.py                    # アプリケーション構造
cat app/api/v1/endpoints/inventory.py  # 在庫API実装
cat app/services/inventory_service.py  # ビジネスロジック
cat app/models/inventory.py       # データベースモデル
```

### 🔧 開発環境の拡張

#### フロントエンド連携
```bash
# プロジェクトルートに移動
cd ../

# フロントエンド環境構築 (今後の予定)
cd frontend/
npm install
npm run generate-api  # OpenAPI-TS型生成
npm run dev
```

#### テスト実行
```bash
# バックエンドディレクトリで
cd backend/
pytest tests/  # 単体テスト実行
```

#### 本格運用準備
```bash
# Docker Compose で全サービス起動
docker-compose up  # フロントエンド + バックエンド + DB
```

### 📖 推奨学習リソース

1. **FastAPI公式ドキュメント**: https://fastapi.tiangolo.com/
2. **PostgreSQL入門**: https://www.postgresql.org/docs/
3. **Redis実践ガイド**: https://redis.io/documentation
4. **WebSocket通信**: MDN WebSocket API
5. **Python非同期プログラミング**: asyncio公式ドキュメント

---

## 🎉 完了チェックリスト

開発環境が正常に構築できたか確認しましょう：

### ✅ 必須確認項目

- [ ] **Docker**: PostgreSQL & Redis が健全に起動
- [ ] **Python**: 仮想環境が有効化され、依存関係がインストール済み
- [ ] **FastAPI**: サーバーが http://localhost:8000 で稼働
- [ ] **ヘルスチェック**: `/health` エンドポイントが正常応答
- [ ] **API ドキュメント**: `/docs` でSwagger UIが表示
- [ ] **データベース**: 在庫アイテム作成・取得が成功
- [ ] **価格管理**: 価格データ作成・取得が成功
- [ ] **WebSocket**: 在庫・価格チャネルへの接続が成功

### 🚀 動作確認コマンド総まとめ

```bash
# 全体的な動作確認
echo "1. Docker サービス確認"
docker-compose ps

echo "2. API ヘルスチェック"
curl http://localhost:8000/health

echo "3. 在庫データ確認"
curl http://localhost:8000/api/v1/inventory/

echo "4. 価格データ確認"  
curl http://localhost:8000/api/v1/price/

echo "5. WebSocket接続テスト"
timeout 3 wscat -c ws://localhost:8000/ws/inventory || echo "WebSocket OK"

echo "🎉 全ての動作確認が完了しました！"
```

---

## 📞 サポート

このガイドで問題が解決しない場合：

1. **ログ確認**: FastAPIサーバーとDockerのログを詳しく確認
2. **公式ドキュメント**: 各ツールの公式ドキュメントを参照
3. **開発チーム**: プロジェクトのREADME.mdやissueを確認

**🎊 おつかれさまでした！FastAPIリアルタイム監視APIの開発環境構築が完了です。**